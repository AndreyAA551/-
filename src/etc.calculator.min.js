!function($){"use strict";var messages={},Language=function(){this.src="",this.init=function(t){var e=this;$.ajax({dataType:"json",url:t}).done(function(t){e.set(t)}).fail(function(){e.set({})})},this.set=function(t){this.src=t},this.get=function(){return this.src}},Translation=function(){this.language=new Language,this.do=function(t){var e=this.language.get();for(var a in void 0===t&&(t={code:"undefined",message:"undefined"}),e)if(t.code===a){t.message=e[a];break}return t}},FlashMessenger=function(){this.namespace="",this.setNamespace=function(t){return this.namespace=t,messages[this.namespace]||(messages[this.namespace]=[]),this},this.addMessage=function(t){void 0!==messages&&messages[this.namespace].push(t)},this.getMessages=function(){var t=messages;return messages={},t},this.destroy=function(){messages={}}},Calculator=function(element,options){this.$element=$(element);var property=this.$element.data("property")&&"string"==typeof this.$element.data("property")?eval("("+this.$element.data("property")+")"):this.$element.data("property");"object"!=typeof property&&(property={}),this.options=$.extend(!0,{},Calculator.defaults,options,property),this.translation=new Translation,this.flashMessenger=new FlashMessenger,this.getCities=function(){var r=this.$element,n=$('[name="cityFrom"]',r),i=$('[name="cityTo"]',r);$.getJSON(this.options.cities).done(function(t){r.data("cities",t.cityList);var e=[];$.each(t.cityList,function(){e.push('<option value="'+this.id+'">'+this.name+"</option>")});var a=e.join("\n");n.append(a).val(n.data("default")||0),i.append(a).val(i.data("default")||0),r.trigger("done.cities.etc.calculator",[t.cityList])}).fail(function(t){r.trigger("fail.cities.etc.calculator",[t])})},this.getCurrency=function(){var e=this.$element,a=$('[name="currency"]',e).empty(),r=0;$.getJSON(this.options.currency).done(function(t){$.each(t,function(){!0===this.default&&(r=this.id),$("<option/>",{val:this.id,text:this.title,"data-currency-abbr":this.abbr}).appendTo(a)}),a.val(r),e.trigger("done.currency.etc.calculator",[t])}).fail(function(t){e.trigger("fail.currency.etc.calculator",[t])})},this.getItems=function(){var t=this.$element,e=[];return $.each($('[data-target="item"]',t),function(){for(var t=0;t<parseInt($('[name^="item.places"]',this).val());t++)e.push({weight:parseFloat(parseFloat($('[name^="item.weight"]',this).val()).toFixed(3)),width:parseFloat(parseFloat($('[name^="item.width"]',this).val()).toFixed(3)),length:parseFloat(parseFloat($('[name^="item.length"]',this).val()).toFixed(3)),height:parseFloat(parseFloat($('[name^="item.height"]',this).val()).toFixed(3))});0===t&&e.push({weight:0,width:0,length:0,height:0})}),e},this.getCityFromServices=function(t){var e=this.$element,r=[],n=t.length||1;return $.each($('[name="city-from-service"]',e),function(t,e){var a=$(e);a.prop("checked")&&r.push({id:parseFloat(a.val()),quantity:n,places:[1]})}),r},this.getPrice=function(){var i=this,s=i.$element;$(".text-warning",'[data-target="item"]').parent(".col-xs-12").detach();var t=i.getItems();$.post(i.options.price,JSON.stringify({cover:parseInt($('[name="cover"]:checked',s).val()),idCurrency:parseInt($('[name="currency"]',s).val()),idCityFrom:parseInt($('[name="cityFrom"]',s).val()),idCityTo:parseInt($('[name="cityTo"]',s).val()),declaredCargoPrice:parseFloat($('[name="declaredCargoPrice"]',s).val()),items:t,CityFromServices:i.getCityFromServices(t)})).done(function(t){var e=!1;$(".has-warning",s).removeClass("has-warning"),$(".help-block.text-warning",s).remove(),$.each(t.transfer,function(){return this.oversize&&(e=!0,$.each(this.oversize.places,function(){var t=$('[data-item-index="'+this.index+'"]',s);t&&$.each(this.reasons,function(){t.find('[name^="item.'+this+'"]').parent(".form-group").addClass("has-warning").append($("<small/>",{class:"help-block text-warning",html:'<i class="fa fa-exclamation-triangle"></i> Негабарит'}))})})),!1}),e&&i.flashMessenger.setNamespace("warning").addMessage("Есть негабаритные места"),i.showResult(t)}).fail(function(t){var e=$.Event("fail.result.etc.calculator"),a=i.translation.do(t.responseJSON).message;if(a=(a=a.replace(/\{cityFrom\}/gi,$('[name="cityFrom"] option:selected',s).text())).replace(/\{cityTo\}/gi,$('[name="cityTo"] option:selected',s).text()),s.trigger(e,[t,a]),e.isDefaultPrevented())return!1;i.flashMessenger.setNamespace("error").addMessage(a)}).always(function(t){s.trigger("always.result.etc.calculator",[t]);var e=[],a=i.flashMessenger.getMessages();if(e.error=$('[data-provide="message-error"]',s).empty(),e.warning=$('[data-provide="message-warning"]',s).empty(),"object"==typeof a)for(var r in a)if($.isArray(a[r])){var n=$(i.options.templates[r],s).eq(0).clone().empty().removeClass("hide").appendTo(e[r]);$.each(a[r],function(){n.append($("<p />",{text:this}))})}})}};Calculator.version="1.0.0",Calculator.prototype.init=function(e){return this.each(function(){var r=$(this),n=r.data("etc.calculator"),t="object"==typeof e&&e;if("object"!=typeof n){var i=0;$(document).ajaxSuccess(function(t,e,a){switch(a.url){case n.options.currency:case n.options.cities:i+=50}100===i&&(i=null,r.trigger("init.etc.calculator",[n]))}),(n=new Calculator(this,t)).translation.language.init(n.options.language.url),n.getCities(),n.getCurrency(),!0===n.options.submitButton&&r.on("submit.etc.calculator",function(t){t.preventDefault(),n.getPrice()}),r.data("etc.calculator",n)}})},Calculator.prototype.getOptions=function(){var t=this.$element.data("etc.calculator");if("object"==typeof t)return t.options},Calculator.prototype.showResult=function(p){var t=this.$element,e=$.Event("show.result.etc.calculator"),a=t.find('[data-provide="result"]');if(t.trigger(e,[p,a]),e.isDefaultPrevented())return!1;var d=" "+$('[name="currency"] option:selected',t).data("currency-abbr"),r=$('[name="currency"] option:selected',t).text(),u="",n=p.transfer?p.transfer.length:0,h=$("<tr/>"),i=$("<tr/>"),s=$("<tr/>"),c=$("<tr/>"),m=$("<tr/>"),o=$("<table/>",{class:"table table-condensed"}).append($("<thead/>"),$("<tfoot/>"),$("<tbody/>"));if(0===p.cover){var l=$("<tr/>"),g=$("<tr/>",{class:"active"});$.each(["Места (шт.)","Общий вес (кг)","Общий объем (м3)"],function(t,e){l.append($("<th/>",{class:"small",text:e}))}),g.append($("<td/>",{text:p.places})),g.append($("<td/>",{text:p.weight})),g.append($("<td/>",{text:p.volume})),$("thead",o).append(l),$("tbody",o).append(g)}var f=$("<table/>",{class:"table"}).append($("<thead/>"),$("<tfoot/>"),$("<tbody/>"));i.append($("<td/>",{class:"hidden-xs",text:"Валюта:"})),h.append($("<td/>",{class:"hidden-xs",text:"Стоимость перевозки:"})),m.append($("<td/>",{class:"hidden-xs",html:$("<strong/>",{text:"Итого:"})}));var v=p.request.price,y=p.delivery.price,x=p.priceInsurance,b=p.priceServiceFrom;if(null!==p.transfer){var w=parseInt(t.find('[name="cityFrom"]').val()),C=parseInt(t.find('[name="cityTo"]').val()),F=t.data("cities"),T="",M="",L=!1,H=!1;$.each(F,function(t,e){w===e.id&&!0===e.isRegionalDelivery&&(L=!0,T=e.name),C===e.id&&!0===e.isRegionalDelivery&&(H=!0,M=e.name)}),$.each(p.transfer.sort(function(t,e){return t.typeId>e.typeId?1:-1}),function(){var t=this.price,e=0,a=t+v+y+x+b;L&&(t+=p.request.price),H&&(t+=p.delivery.price);var r="";if(this.oversize){e=parseFloat(this.oversize.price),u="** - Возможно увеличение стоимости перевозки. За дополнительной информацией обратитесь в контактный центр по номеру 8-800-700-7000.";var n=e+v+y+x+b;r=$("<span/>",{class:"text-warning",html:$("<span/>",{"data-result":"priceTotalAll","data-price-total-all":n,"data-spincrement":"true",text:n})[0].outerHTML+d+"(с учётом негабарита)"})[0].outerHTML,L&&(e+=p.request.price),H&&(e+=p.delivery.price);var i=$("<span/>",{class:"text-warning",html:$("<span/>",{"data-result":"price","data-spincrement":"true",text:e})[0].outerHTML+d+" **"})}var s=$("<span/>",{"data-result":"price","data-spincrement":"true",text:t}),c=$("<span/>",{"data-result":"priceTotal","data-price-total":a,"data-spincrement":"true",text:a})[0].outerHTML+d,o=$("<span/>",{"data-result":"interval","data-price-total":this.interval,class:"text-muted",text:"Срок доставки от {interval} рабочих дней".replace(/\{interval\}/gi,this.interval.replace(/дней/gi,""))})[0].outerHTML,l=$("<dl/>").append($("<dt/>",{class:"visible-xs",text:"Итого:"})).append($("<dd/>",{html:c+(this.oversize?"<br>"+r:"")+(this.interval?"<br>"+o:"")}));h.append($("<td/>",{class:"active",html:$("<small/>",{text:this.type,class:"text-muted"})[0].outerHTML+"<br>"+(e?s[0].outerHTML+d+"<br>"+i[0].outerHTML:s[0].outerHTML+d)+(L?'<br><small class="text-muted">'+T+": не имеет терминала, стоимость перевозки с учётом забора груза</small>":"")+(H?'<br><small class="text-muted">'+M+": не имеет терминала, стоимость перевозки с учётом доставки груза</small>":"")})),m.append($("<td/>",{html:l}))})}i.append($("<td/>",{"data-result":"currency",colspan:n,html:r}));var I=$("<dl/>",{class:"dl-horizontal text-nowrap"}),j=$("<span/>",{"data-result":"priceDelivery","data-spincrement":"true",text:y}),k=$("<span/>",{"data-result":"priceRequest","data-spincrement":"true",text:v}),S=$("<span/>",{"data-result":"priceInsurance","data-spincrement":"true",text:x}),P=$("<span/>",{"data-result":"priceServices","data-spincrement":"true",text:b});L||I.append($("<dt/>",{text:"Доставка от отправителя до терминала"})).append($("<dd/>",{html:k[0].outerHTML+d})),H||I.append($("<dt/>",{text:"Доставка от терминала до получателя"})).append($("<dd/>",{html:j[0].outerHTML+d})),I.append($("<dt/>",{text:"Страховка"})).append($("<dd/>",{html:S[0].outerHTML+d})),I.append($("<dt/>",{text:"Упаковка груза"})).append($("<dd/>",{html:P[0].outerHTML+d})),L&&H||c.append($("<td/>",{class:"hidden-xs",text:"Дополнительные услуги:"}),$("<td/>",{colspan:n,html:I})),$("tbody",f).append(i,h,s,c),$("tfoot",f).append(m),a.empty().append(f).append('<p class="text-warning">'+u+"</p>"),t.trigger("shown.result.etc.calculator",[p,a])},Calculator.prototype.submit=function(){this.data("etc.calculator").getPrice()},Calculator.prototype.destroyResult=function(){var t=this.find('[data-provide="result"]');if(t.length){var e=$.Event("destroy.result.etc.calculator");if(this.trigger(e,[t]),e.isDefaultPrevented())return!1;t.empty(),this.trigger("destroyed.result.etc.calculator",[t])}};var old=$.fn.calculator;$.fn.calculator=function(t){var e=Calculator.prototype;return"string"==typeof t&&e[t]?e[t].apply(this,[].slice.call(arguments,1)):"object"!=typeof t&&t?void $.error("The method named "+t+" does not exist for jQuery.calculator"):e.init.apply(this,arguments)},Calculator.defaults={currency:"https://api2.nrg-tk.ru/v2/currency",cities:"https://api2.nrg-tk.ru/v2/cities",price:"https://api2.nrg-tk.ru/v2/price",language:{url:""},templates:{error:".bs-callout-danger",warning:".bs-callout-warning"},submitButton:!0},$.fn.calculator.Constructor=Calculator,$.fn.calculator.noConflict=function(){return $.fn.calculator=old,this},$(document).ready(function(t){$('[data-provide^="calculator"]',document).trigger("click.etc.calculator.data-api")}).on("click.etc.calculator.data-api",'[data-provide^="calculator"]',function(){var t=$(this);t.data("etc.calculator")||t.calculator(t.data())})}(jQuery);